name: Validate Setup

on:
  schedule:
    # Run every day at 6 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:

jobs:
  validate:
    name: Validate Project Setup
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Lando
        uses: lando/setup-lando@v3
        with:
          lando-version: stable
          config: core.telemetry=false
      
      - name: Start Lando
        run: lando start
      
      - name: Run setup validation
        run: lando setup-check
      
      - name: Check environment variables
        run: lando node scripts/validate-environment.js
      
      - name: Test database connection
        run: |
          lando psql -c 'SELECT version();'
      
      - name: Verify all tooling commands
        run: |
          lando npm --version
          lando node --version
          lando lint --version || true
          lando format --version || true
      
      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ Setup validation failed',
              body: `Setup validation failed on ${new Date().toISOString()}\n\nCheck the workflow run: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              labels: ['bug', 'automation']
            })
      
      - name: Stop Lando
        if: always()
        run: lando destroy -y