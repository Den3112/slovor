name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  test:
    name: Test & Lint
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Lando
        uses: lando/setup-lando@v3
        with:
          lando-version: stable
          auto-setup: lando setup
          config: |
            core.telemetry=false
      
      - name: Start Lando
        run: lando start
      
      - name: Verify installation
        run: |
          lando info
          lando node --version
          lando npm --version
      
      - name: Run setup check
        run: lando setup-check
      
      - name: Run linting
        run: lando lint
      
      - name: Run type checking
        run: lando tsc
      
      - name: Run tests
        run: lando test
      
      - name: Build production
        run: lando build
      
      - name: Show logs on failure
        if: failure()
        run: lando logs
      
      - name: Stop Lando
        if: always()
        run: lando destroy -y

  deploy-preview:
    name: Deploy Preview
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy to Vercel Preview
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          scope: slovors-projects
      
      - name: Comment PR
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… Preview deployed! Check the deployment in Vercel dashboard.'
            })

  deploy-production:
    name: Deploy Production
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy to Vercel Production
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
          scope: slovors-projects
      
      - name: Create release comment
        uses: actions/github-script@v7
        with:
          script: |
            const commit = context.sha.substring(0, 7);
            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: `ðŸš€ Deployed to production: https://slovor.vercel.app\n\nCommit: ${commit}`
            })