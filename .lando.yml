name: slovor
recipe: node

config:
  node: '18'
  webroot: slovor

services:
  appserver:
    type: node:18
    scanner: false
    
    ports:
      - '3000:3000'    # Next.js dev server
      - '54321:54321'  # Supabase local
    
    build:
      - cd slovor && npm install --legacy-peer-deps || npm install --force
    
    overrides:
      environment:
        NODE_ENV: development
        DATABASE_URL: postgres://postgres:postgres@database:5432/slovor
        NEXT_PUBLIC_SUPABASE_URL: https://rsywmmnxkvwvhgrgzlei.supabase.co
        NEXT_PUBLIC_SUPABASE_ANON_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJzeXdtbW54a3Z3dmhncmd6bGVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyMDA0MjAsImV4cCI6MjA4MDc3NjQyMH0.pNzBIic-uopmLaP8iU3VtQGasTmicyK-loUMbocYZq0
        # WSL2 file watching optimizations
        WATCHPACK_POLLING: 'true'
        CHOKIDAR_USEPOLLING: 'true'
        CHOKIDAR_INTERVAL: 1000
  
  database:
    type: postgres:15
    portforward: 5432
    
    creds:
      user: postgres
      password: postgres
      database: slovor
    
    config:
      database: slovor/supabase/migrations

tooling:
  npm:
    service: appserver
    description: Run npm commands
    cmd: cd slovor && npm
  
  node:
    service: appserver
    description: Run node commands
    cmd: cd slovor && node
  
  npx:
    service: appserver
    description: Run npx commands
    cmd: cd slovor && npx
  
  dev:
    service: appserver
    description: Start Next.js development server
    cmd: cd slovor && npm run dev
  
  build:
    service: appserver
    description: Build Next.js for production
    cmd: cd slovor && npm run build
  
  start:
    service: appserver
    description: Start production server
    cmd: cd slovor && npm run start
  
  lint:
    service: appserver
    description: Run ESLint
    cmd: cd slovor && npm run lint
  
  lint:fix:
    service: appserver
    description: Auto-fix ESLint issues
    cmd: cd slovor && npm run lint -- --fix
  
  format:
    service: appserver
    description: Format code with Prettier
    cmd: cd slovor && npm run format
  
  test:
    service: appserver
    description: Run tests
    cmd: cd slovor && npm run test
  
  tsc:
    service: appserver
    description: TypeScript type checking
    cmd: cd slovor && npx tsc --noEmit
  
  health:
    service: appserver
    description: Quick health check (lint + typecheck)
    cmd: |
      cd slovor &&
      npm run lint &&
      npx tsc --noEmit
  
  doctor:
    service: appserver
    description: Full system health check
    cmd: bash scripts/lando-doctor.sh
  
  setup-check:
    service: appserver
    description: Validate project setup
    cmd: bash scripts/setup-check.sh
  
  setup-repair:
    service: appserver
    description: Auto-repair project setup
    cmd: bash scripts/setup-repair.sh
  
  psql:
    service: database
    description: Connect to PostgreSQL
    cmd: psql -U postgres slovor
  
  db-dump:
    service: database
    description: Dump database to stdout
    cmd: pg_dump -U postgres slovor
  
  db-reset:
    service: database
    description: Reset database
    cmd: psql -U postgres -c 'DROP DATABASE IF EXISTS slovor; CREATE DATABASE slovor;'
  
  db-migrate:
    service: appserver
    description: Run Supabase migrations
    cmd: cd slovor && supabase db push
  
  logs:
    service: appserver
    description: Show container logs
    cmd: tail -f /var/log/* 2>/dev/null || echo "No logs available"

events:
  pre-start:
    - appserver: echo "ğŸ” Running pre-start checks..."
    - appserver: bash scripts/pre-start-check.sh || true
  
  post-start:
    - appserver: echo ""
    - appserver: echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    - appserver: echo "ğŸš€ Slovor Development Environment (WSL2 + Docker)"
    - appserver: echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    - appserver: echo ""
    - appserver: echo "ğŸ“¦ Checking dependencies..."
    - appserver: bash scripts/setup-check.sh || bash scripts/setup-repair.sh
    - appserver: echo ""
    - appserver: echo "âœ… Environment ready!"
    - appserver: echo ""
    - appserver: echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    - appserver: echo "ğŸ“š Quick Commands:"
    - appserver: echo "   lando dev          â†’ Start dev server"
    - appserver: echo "   lando health       â†’ Quick health check"
    - appserver: echo "   lando doctor       â†’ Full diagnostics"
    - appserver: echo "   lando lint         â†’ Run linting"
    - appserver: echo "   lando test         â†’ Run tests"
    - appserver: echo "   lando psql         â†’ Database shell"
    - appserver: echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    - appserver: echo "ğŸŒ URLs:"
    - appserver: echo "   App: http://localhost:3000"
    - appserver: echo "   API: http://localhost:3000/api"
    - appserver: echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    - appserver: echo ""